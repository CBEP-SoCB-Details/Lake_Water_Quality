---
title: "Analysis of Frequency of Secchi Observations by Lake and Year"
output:
  html_document:
    df_print: paged
---
# Load Libraries
```{r}
library(tidyverse)
library(readxl)
```

# Read Data
Here we read in the data, do a lot of renaming, and convert some to factors, and finally, add a Year term.  Note the filter removing NAs is because one lake is included in these data but has no actual data -- only NAs for the Secchi Depth.
```{r}
sibfldnm <- 'Derived Data'
parent <- dirname(getwd())
sibling <- paste(parent,sibfldnm, sep = '/')
fn <- 'Secchi.xlsx'



secchi.data <- read_excel(paste(sibling, fn, sep='/'), col_types = c("skip", 
    "numeric", "text", "numeric", "date", 
    "text", "numeric", "text", "text", "numeric", 
    "numeric", "text")) %>%
  rename_at(2:11, ~paste(substr(.,1,1), tolower(substr(.,2,nchar(.))), sep='')) %>%  # Change capitalization
  rename(Secchi = `Secchi depth`) %>%
  filter(! is.na(Secchi)) %>%
  mutate(MIDAS = factor(MIDAS)) %>%
  rename(CensoredFlag = `Secchi on bottom?`) %>%
  mutate(CensoredFlag = CensoredFlag == 'B') %>%
  mutate(Scope = factor(Scope, levels = as.character(1:5),
                        labels = c('None', 'Plain', 'Slant', 'Slant with Mask', 'Flat with Mask'))) %>%
  rename(Wind = `Wind level`) %>%
  rename(WindDir = `Wind direction` ) %>%
  mutate(WindDir = factor (WindDir, levels = 1:8, labels = c('N', 'NE', 'E', 'SE', 'S', 'Sw', 'W', 'NW'))) %>%
  rename(CloudCover = `Cloud cover`) %>%
  mutate(CloudCover = factor (CloudCover, levels = c('B', 'C', 'O'), labels = c('Clear', 'Cloudy Bright' , 'Heavy Overcast'))) %>%
  mutate(Year = as.numeric(format(Date, format = '%Y'))) %>%
  mutate(Month = as.numeric(format(Date, format = '%m'))) 

```

# Questions for Linda Bacon:
Where there is no wind estimate, does that mean the wind was calm?  Or only that data was not collected?
Why is there some rows in this data where the Secchi value is absent?
How reliable do you think the "Secchi on Bottom" records are?  Especially historically. (Focus on last 10 years)

# Read Morphometric Data
Read in morphometric data, and filter to lakes for which we have at lest some Secchi data.
```{r}
fn <- 'CB_Lakes_Morphometry Metric.xlsx'
morpho.data <- read_excel(paste(sibling, fn, sep='/')) %>% 
  filter(MIDAS %in% levels(factor(secchi.data$MIDAS)))
rm(fn,parent,sibfldnm,sibling)
```

# Evaluate Frequency of Data by Year
The goal here is to provide a graphic that uses a heat map to show how many Secchi observations each lake has in each year.  As usual, the first step is to construct data in the right format to do what we want.  Note that "MIDAS2" here is just a reordered version of the MIDAS class, to create a graphic ordered by sampling history.
```{r}
totals <- secchi.data %>%
  group_by(MIDAS) %>%
  summarize(Total = sum(! is.na(Secchi)))

counts <- secchi.data %>%
  group_by(MIDAS, Year) %>%
  summarize(Number = sum(! is.na(Secchi))) %>%
  mutate(MIDAS2 = factor(MIDAS, levels = unique(totals$MIDAS[order(totals$Total)]))) %>%
  mutate(Name = morpho.data$Name[match(MIDAS, morpho.data$MIDAS)])
rm(totals)
```


```{r fig.height = 9, fig.width =9}
plt <- ggplot(counts, aes(MIDAS2, Year)) + geom_raster(aes(fill = Number)) +
  theme_minimal() +
  scale_x_discrete(breaks=counts$MIDAS2, labels=counts$Name) +
  scale_fill_gradient(trans='log10', breaks = c(1,5,10,50)) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab('') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  coord_flip()
plt
```

# Set Some Criteria
For analysis of current conditions, we only want lakes for which we have data from at least five of the last ten years  (2009-2018).
We will let data density speak for itself in terms of estimating statistical significance, so we won't arbitrarily set a sample size criterion yet.  (Note that in 2015, we used the last 15 years of data to describe recent TRENDS.  I'm not 100% certain what we used for recent STATUS.)

For trend analyses, we want a minimum of fifteen years of data, at least five of which are from the most recent ten years.  We can figure that out by replacing the number of samples each year to a one (or TRUE) for years with some observations, and summing across the years of interest.
```{r}
sampled <- counts %>%
  mutate(Sampled = Number>0) %>%
  select (-Number) %>%
  group_by(MIDAS) %>%
  summarize(allyears = sum(Sampled), recentyears = sum(Sampled[Year>2008], na.rm=TRUE))
```

Lets examine those two sets of lakes.
```{r}
RecentLakesMIDAS <- sampled$MIDAS[sampled$recentyears>=5]
TrendLakesMIDAS  <- sampled$MIDAS[sampled$recentyears>=5 & (sampled$allyears-sampled$recentyears)>=10]
morpho.data$Name[RecentLakesMIDAS[! RecentLakesMIDAS %in%  TrendLakesMIDAS]]
```
So almost all (all but three) of the lakes we might want to look at recently can also be used to estimate trends.